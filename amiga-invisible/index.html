
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Mini‚Äëcrafting ‚Äî Carta de la amiga invisible</title>
  <style>
    :root{
      --ui:#0f172a;
      --panelW:min(560px,96vw); /* panel m√°s ancho para acompa√±ar la caja */
    }
    html,body{height:100%;margin:0;background:#f0f9ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{width:var(--panelW);margin:14px auto 10px;display:flex;justify-content:space-between;align-items:center;color:var(--ui)}
    header .stat{display:flex;gap:12px;align-items:center;font-weight:600}
    .badge{padding:6px 10px;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.07)}
    canvas{display:block;margin:6px auto;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.12);touch-action:none}
    #panel{width:var(--panelW);margin:10px auto 18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:#fff;color:#0f172a;border-radius:12px;padding:8px 12px;box-shadow:0 2px 10px rgba(0,0,0,.1);font-weight:600}
    .btn:active{transform:translateY(1px)}
    #power{background:linear-gradient(180deg,#ffe082,#ffd54f)}
    #power[disabled]{filter:grayscale(.8);opacity:.7}
    footer{width:var(--panelW);margin:6px auto 22px;color:#3c4a4a;font-size:.92rem;text-align:center}
    #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
    #overlay .card{width:min(600px,92vw);background:#fff;color:#0f172a;padding:18px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:center}
    @media (max-width:420px){ header{font-size:14px} }
  </style>
</head>
<body>
  <header>
    <div class="stat">
      <span class="badge">‚åõ <strong id="time">00:00</strong></span>
      <span class="badge">üéØ Puntos: <strong id="score">0</strong></span>
      <span class="badge">üß∞ Receta: <strong id="recipe">‚Äî</strong></span>
    </div>
    <div class="stat">
      <span class="badge">üèÜ R√©cord: <strong id="best">0</strong></span>
      <button class="btn" id="pause">‚è∏Ô∏è Pausa</button>
    </div>
  </header>

  <!-- ‚úÖ Canvas m√°s ancho para albergar una caja mayor -->
  <canvas id="game" width="420" height="680" aria-label="Mini-crafting"></canvas>

  <div id="panel">
    <button class="btn" id="power" title="Comod√≠n (coloca un √≠tem que falte) ‚Äî 1 uso">üÉè Comod√≠n</button>
    <button class="btn" id="restart">üîÑ Reiniciar</button>
  </div>

  <footer>
    Carta: <strong>amiga invisible</strong>
  </footer>

  <!-- üèÜ Tabla de puntuaciones (Top 10) ‚Äî igual que en los otros juegos -->
  <section id="scoreboard" aria-labelledby="scoreboard-title" style="width:var(--panelW);margin:0 auto 16px;">
    <h3 id="scoreboard-title" style="margin:8px 0;color:#2b2b2b;font-weight:700;">üèÜ Mejores puntuaciones</h3>
    <div style="background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);padding:10px 12px;color:#0f172a;font-size:.95rem;">
      <ol id="score-list" style="margin:0;padding-left:20px;">
        <!-- Se rellena por JS -->
      </ol>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button class="btn" id="scores-refresh" title="Actualizar tabla">üîÅ Actualizar</button>
        <button class="btn" id="scores-clear" title="Borrar tabla">üóëÔ∏è Borrar</button>
      </div>
    </div>
  </section>

  <div id="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h2>Mini‚Äëcrafting</h2>
      <!-- Mensaje de bienvenida personalizado -->
      <p id="welcome">¬øPuedes ayudarme metiendo las herramientas que necesito en las cajas?</p>
      <ul style="text-align:left;max-width:560px;margin:10px auto;">
        <li><strong>Movimiento:</strong> toca un √≠tem y arr√°stralo. Su√©ltalo sobre la caja.</li>
        <li><strong>Recetas:</strong> 3 niveles; cada uno exige 3 √≠tems.</li>
        <li><strong>Puntuaci√≥n:</strong> +50 por √≠tem correcto, +100 por receta completa, combo por rapidez.</li>
      </ul>
      <button class="btn" id="start">‚ñ∂Ô∏è Empezar</button>
    </div>
  </div>

<script>
(function(){
  /* ===================== Canvas y escala ===================== */
  var DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var baseW = canvas.width, baseH = canvas.height;
  canvas.width = baseW * DPR; canvas.height = baseH * DPR;
  canvas.style.width = baseW + 'px'; canvas.style.height = baseH + 'px';
  ctx.scale(DPR, DPR);

  /* ===================== UI ===================== */
  var timeEl = document.getElementById('time');
  var scoreEl = document.getElementById('score');
  var recipeEl = document.getElementById('recipe');
  var bestEl = document.getElementById('best');
  var overlay = document.getElementById('overlay');
  var startBtn = document.getElementById('start');
  var pauseBtn = document.getElementById('pause');
  var restartBtn = document.getElementById('restart');
  var powerBtn = document.getElementById('power');

  var RECORD_KEY = 'crafting_best_amiga';
  bestEl.textContent = +localStorage.getItem(RECORD_KEY) || 0;

  /* ======= üèÜ Tabla de puntuaciones (Top 10) ======= */
  var SCORE_KEY = 'crafting_scores_amiga'; // ranking igual que en los otros juegos

  function fmt(ms){
    var s = Math.floor(ms/1000);
    var mm = String(Math.floor(s/60)).padStart(2,'0');
    var ss = String(s%60).padStart(2,'0');
    return mm+':'+ss;
  }
  function loadScores(){
    try { var raw = localStorage.getItem(SCORE_KEY); return raw ? JSON.parse(raw) : []; }
    catch(e){ return []; }
  }
  function saveScores(list){
    try { localStorage.setItem(SCORE_KEY, JSON.stringify(list)); } catch(e){}
  }
  // Orden: mayor puntuaci√≥n primero; desempate: menor tiempo
  function addScore(entry){
    var list = loadScores();
    list.push(entry);
    list.sort(function(a,b){ return (b.score - a.score) || (a.ms - b.ms) || (a.when - b.when); });
    saveScores(list.slice(0,10));
  }
  function renderScores(){
    var ol = document.getElementById('score-list'); if (!ol) return;
    var list = loadScores();
    if (!list.length){ ol.innerHTML = '<li>No hay puntuaciones todav√≠a. ¬°Juega y entrar√°s en la tabla!</li>'; return; }
    ol.innerHTML = list.map(function(r,i){
      var d = new Date(r.when);
      var when = d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
      return '<li><strong>#'+(i+1)+'</strong> ‚Äî '+r.score+' pts ¬∑ '+fmt(r.ms)+' ¬∑ '+when+'</li>';
    }).join('');
  }
  (function wireScoreboard(){
    var btnRefresh = document.getElementById('scores-refresh');
    var btnClear   = document.getElementById('scores-clear');
    if (btnRefresh) btnRefresh.addEventListener('click', renderScores);
    if (btnClear)   btnClear.addEventListener('click', function(){ localStorage.removeItem(SCORE_KEY); renderScores(); });
    renderScores();
  })();
  /* ======= Fin ranking ======= */

  /* ===================== Paletas por receta (cielo/suelo) ===================== */
  var THEMES = {
    'Colgar cuadro':   { sky:'#e3f2fd', floor:'#c8e6c9' },
    'Reparar libro':   { sky:'#fff3e0', floor:'#ffe0b2' },
    'Pintar esquina':  { sky:'#fce4ec', floor:'#f8bbd0' }
  };

  /* ===================== Mundo ===================== */
  var world = { w: baseW, h: baseH, groundY: baseH-70, running:false, paused:false, time:0, duration:75*1000 };

  /* ‚úÖ Caja a√∫n m√°s ancha (selecci√≥n/colocaci√≥n) */
  var box = { x: baseW/2-160, y: world.groundY-150, w: 320, h: 140, slots: [] };

  /* ===================== Protagonista ===================== */
  var hero = { x: baseW/2-28, y: world.groundY-220, w: 56, h: 96, sprite:new Image() };
  hero.sprite.src = 'assets/amiga-invisible.png';

  /* ===================== Iconos personalizados (rutas que t√∫ subir√°s) ===================== */
  var ICON_IMG_SRC = {
    martillo:  'assets/martillo.png',
    clavos:    'assets/clavos.png',
    nivel:     'assets/nivel.png',
    pegamento: 'assets/pegamento.png',
    clip:      'assets/clip.png',
    papel:     'assets/papel.png',
    pincel:    'assets/pincel.png',
    paleta:    'assets/paleta.png',
    carrocero: 'assets/carrocero.png'
  };
  var ICON_IMG = {};
  Object.keys(ICON_IMG_SRC).forEach(function(k){
    var img = new Image();
    img.src = ICON_IMG_SRC[k];
    ICON_IMG[k] = img;
  });

  /* ===================== Vector de respaldo (plano, vibrante) ===================== */
  var ITEMS = [
    { key:'martillo', draw:function(x,y,s){ ctx.fillStyle='#546e7a'; ctx.fillRect(x-s*0.45,y-s*0.10,s*0.9,s*0.22); ctx.fillStyle='#8d6e63'; ctx.fillRect(x-s*0.06,y+s*0.12,s*0.12,s*0.70); }},
    { key:'clavos', draw:function(x,y,s){ ctx.fillStyle='#37474f'; for(var i=0;i<3;i++){ var ox=-s*0.25+i*s*0.25; ctx.fillRect(x+ox,y-s*0.05, s*0.08, s*0.40); ctx.fillRect(x+ox-2,y-s*0.08, s*0.12, s*0.06); } }},
    { key:'nivel', draw:function(x,y,s){ ctx.fillStyle='#43a047'; ctx.fillRect(x-s*0.40,y-s*0.12,s*0.80,s*0.24); ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.fillRect(x-s*0.30,y-s*0.06,s*0.60,s*0.12); ctx.fillStyle='#ffeb3b'; ctx.beginPath(); ctx.arc(x, y, s*0.04, 0, Math.PI*2); ctx.fill(); }},
    { key:'papel', draw:function(x,y,s){ ctx.fillStyle='#eceff1'; roundRectPath(x-s*0.28,y-s*0.34,s*0.56,s*0.68,10); ctx.fill(); ctx.fillStyle='#b0bec5'; ctx.fillRect(x-s*0.20, y-s*0.20, s*0.40, s*0.04); ctx.fillRect(x-s*0.20, y-s*0.10, s*0.36, s*0.04); ctx.fillRect(x-s*0.20, y, s*0.28, s*0.04); }},
    { key:'carrocero', draw:function(x,y,s){ ctx.fillStyle='#ffd54f'; ctx.beginPath(); ctx.arc(x,y,s*0.24,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(x,y,s*0.12,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over'; ctx.fillStyle='#ffca28'; ctx.fillRect(x+s*0.12, y-s*0.02, s*0.22, s*0.08); }},
    { key:'pegamento', draw:function(x,y,s){ ctx.fillStyle='#ef5350'; ctx.fillRect(x-s*0.18,y-s*0.10,s*0.36,s*0.46); ctx.fillStyle='#fff'; ctx.fillRect(x-s*0.14,y+s*0.02,s*0.28,s*0.18); ctx.fillStyle='#b71c1c'; ctx.fillRect(x-s*0.06,y-s*0.26,s*0.12,s*0.16); }},
    { key:'pincel', draw:function(x,y,s){ ctx.fillStyle='#8d6e63'; ctx.beginPath(); ctx.moveTo(x-s*0.24,y+s*0.28); ctx.lineTo(x,y-s*0.06); ctx.lineTo(x+s*0.24,y+s*0.28); ctx.closePath(); ctx.fill(); ctx.fillStyle='#90caf9'; ctx.fillRect(x-s*0.08,y-s*0.40,s*0.16,s*0.32); }},
    { key:'paleta', draw:function(x,y,s){ ctx.fillStyle='#ffe082'; ctx.beginPath(); ctx.arc(x,y,s*0.40,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(x+s*0.20,y,s*0.12,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over'; ['#ef5350','#66bb6a','#42a5f5','#ab47bc'].forEach(function(c,i){ ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x- s*0.20 + i*s*0.12, y+s*0.10 - (i%2)*s*0.06, s*0.06,0,Math.PI*2); ctx.fill(); }); }},
    { key:'clip', draw:function(x,y,s){ ctx.strokeStyle='#546e7a'; ctx.lineWidth = Math.max(2, s*0.12); ctx.beginPath(); ctx.moveTo(x-s*0.14,y-s*0.02); ctx.quadraticCurveTo(x+s*0.20,y-s*0.10, x+s*0.12,y+s*0.28); ctx.quadraticCurveTo(x,y+s*0.40, x-s*0.10,y+s*0.18); ctx.stroke(); } }
  ];

  function drawItemWithImageOrVector(key, cx, cy, s){
    var img = ICON_IMG[key];
    if (img && img.complete && img.naturalWidth && img.naturalWidth > 0) {
      ctx.drawImage(img, cx - s*0.5, cy - s*0.5, s, s);
    } else {
      var def = null;
      for (var ii=0; ii<ITEMS.length; ii++){ if (ITEMS[ii].key===key){ def=ITEMS[ii]; break; } }
      if (def) def.draw(cx, cy, s);
    }
  }

  /* ===================== Recetas ===================== */
  var RECIPES = [
    { name:'Colgar cuadro', need:['martillo','clavos','nivel'] },
    { name:'Reparar libro',  need:['pegamento','clip','papel'] },
    { name:'Pintar esquina', need:['pincel','paleta','carrocero'] }
  ];

  /* Etiquetas visibles */
  var DISPLAY = {
    martillo:'Martillo', clavos:'Clavos', nivel:'Nivel de burbuja',
    pegamento:'Pegamento', clip:'Clip', papel:'Hoja de papel',
    pincel:'Pincel', paleta:'Paleta', carrocero:'Cinta de carrocero'
  };

  /* ===================== Estado ===================== */
  var score=0, combo=1, comboTimer=0, level=0, currentRecipe=null;

  /* ===================== Bancada: √≠tems arrastrables ===================== */
  var bench = { items:[] };

  function shuffle(arr){
    for (var i=arr.length-1; i>0; i--){
      var j = Math.floor(Math.random()*(i+1));
      var tmp = arr[i]; arr[i]=arr[j]; arr[j]=tmp;
    }
    return arr;
  }

  /* ‚úÖ Aleatoriza las posiciones de los 3 necesarios y 3 distractores */
  function spawnBenchFor(recipe){
    // Limpiar bancada
    bench.items = [];

    // 1) Claves necesarias (3)
    var needed = recipe.need.slice();
    // 2) Pool total
    var poolAll = ITEMS.map(function(it){ return it.key; });
    // 3) Pool de distractores (excluye necesarios)
    var distractorPool = [];
    for (var p=0; p<poolAll.length; p++){
      var key = poolAll[p];
      if (needed.indexOf(key) === -1) distractorPool.push(key);
    }
    // 4) Elegir 3 distractores √∫nicos
    shuffle(distractorPool);
    var distractors = distractorPool.slice(0, 3);
    // 5) Unir (3 necesarios + 3 distractores)
    var keys = needed.concat(distractors);
    // 6) Barajar el conjunto para que los √≠ndices (y por tanto las posiciones) sean aleatorios
    shuffle(keys);
    // 7) Crear los 6 √≠tems posicionados por √≠ndice ya barajado (3x2 centrados)
    for (var i=0; i<keys.length; i++){
      bench.items.push(makeBenchItem(keys[i], i));
    }
  }

  // Crea un item para la bancada con coordenadas seg√∫n √≠ndice (cuadr√≠cula 3x2), centrado en pantalla
  function makeBenchItem(key, idx){
    var cols = 3;
    var col = idx % cols;
    var row = Math.floor(idx / cols);
    var spacingX = 120; // separaci√≥n horizontal entre columnas
    var startX = world.w/2 - ((cols-1)*spacingX)/2; // centrado respecto al canvas
    var x = startX + col * spacingX;
    var y = 120 + row * 130;             // separaci√≥n vertical
    return { key:key, x:x, y:y, s:56, dragging:false, dx:0, dy:0, placed:false };
  }

  /* ===================== Slots m√°s separados y legibles ===================== */
  function buildSlots(recipe){
    var spacing = 104;              // separaci√≥n mayor gracias a la caja de 320 px
    var slotW = 54, slotH = 54;     // slots algo m√°s grandes
    box.slots = recipe.need.map(function(key,i){
      return { key:key, x: box.x + 18 + i*spacing, y: box.y + 18, w: slotW, h: slotH, filled:false };
    });
  }

  /* ===================== HUD ===================== */
  function updateHUD(){
    scoreEl.textContent = score;
    recipeEl.textContent = currentRecipe ? currentRecipe.name : '‚Äî';
    var remain = Math.max(0, Math.ceil((world.duration - world.time)/1000));
    timeEl.textContent = String(Math.floor(remain/60)).padStart(2,'0') + ':' + String(remain%60).padStart(2,'0');
  }

  /* ===================== Juego ===================== */
  function startGame(){
    score=0; combo=1; comboTimer=0; level=0; world.time=0;
    currentRecipe = RECIPES[level];
    spawnBenchFor(currentRecipe);
    buildSlots(currentRecipe);
    world.running=true; world.paused=false;
    overlay.style.display='none';
    powerBtn.disabled=false; pauseBtn.textContent='‚è∏Ô∏è Pausa';
    loop(performance.now());
  }

  function endGame(win){
    world.running=false;
    var best = +localStorage.getItem(RECORD_KEY) || 0;
    localStorage.setItem(RECORD_KEY, Math.max(best, score));
    bestEl.textContent = localStorage.getItem(RECORD_KEY);
    document.getElementById('start').textContent = '‚ñ∂Ô∏è Repetir';
    var title = win ? '¬°Recetas completadas!' : 'Se acab√≥ el tiempo';
    var extra = win ? '<br><br><strong>¬°Muchas gracias! Ahora ya puedo terminar de construir mi casa.</strong>' : '';
    document.querySelector('#overlay .card h2').textContent = title;
    document.querySelector('#overlay .card p').innerHTML =
      'Puntos: <strong>'+score+'</strong> ¬∑ R√©cord: <strong>'+bestEl.textContent+'</strong><br>'+
      'Receta actual: <strong>'+(currentRecipe ? currentRecipe.name : '‚Äî')+'</strong>' + extra;

    // üèÜ A√±adir puntuaci√≥n al ranking y refrescar tabla (igual que en los otros juegos)
    addScore({ score: score, ms: world.time, when: Date.now() });
    renderScores();

    overlay.style.display='flex';
  }

  /* ===================== Update & Draw ===================== */
  function update(dt){
    if (world.paused) return;
    world.time += dt;
    if (world.time >= world.duration) { endGame(false); return; }
    if (comboTimer>0){ comboTimer -= dt; if (comboTimer<=0){ comboTimer=0; combo=1; } }
  }

  function draw(){
    ctx.clearRect(0,0,world.w, world.h);

    // Fondo seg√∫n la receta
    var theme = THEMES[currentRecipe ? currentRecipe.name : ''] || { sky:'#bbdefb', floor:'#a5d6a7' };
    ctx.save();
    ctx.fillStyle = theme.sky;   ctx.fillRect(0,0,world.w, world.h*0.72);
    ctx.fillStyle = theme.floor; ctx.fillRect(0,world.h*0.72, world.w, world.h*0.28);
    ctx.restore();

    // Protagonista
    ctx.drawImage(hero.sprite, hero.x, hero.y, hero.w, hero.h);

    // Caja (a√∫n m√°s ancha)
    ctx.fillStyle='#8d6e63'; roundRect(box.x, box.y, box.w, box.h, 12, true);
    ctx.fillStyle='#6d4c41'; roundRect(box.x+8, box.y+78, box.w-16, 22, 8, true);

    // Slots + etiquetas tipo ‚Äúp√≠ldora‚Äù
    for (var si=0; si<box.slots.length; si++){
      var sl = box.slots[si];
      ctx.fillStyle= sl.filled ? '#81c784' : '#ffffff';
      roundRect(sl.x, sl.y, sl.w, sl.h, 10, true);

      var label = DISPLAY[sl.key] || sl.key;
      var padX = 8;
      ctx.font = 'bold 12px system-ui';
      var textW = ctx.measureText(label).width;
      var pillW = Math.max(textW + padX*2, sl.w + 24);
      var pillH = 24;
      var pillX = sl.x + sl.w/2 - pillW/2;
      var pillY = sl.y + sl.h + 28;

      ctx.fillStyle = '#ffffff';
      roundRect(pillX, pillY, pillW, pillH, 12, true);
      ctx.strokeStyle = 'rgba(0,0,0,.08)';
      ctx.beginPath();
      ctx.moveTo(pillX+12, pillY);
      ctx.arcTo(pillX+pillW, pillY, pillX+pillW, pillY+pillH, 12);
      ctx.arcTo(pillX+pillW, pillY+pillH, pillX, pillY+pillH, 12);
      ctx.arcTo(pillX, pillY+pillH, pillX, pillY, 12);
      ctx.arcTo(pillX, pillY, pillX+pillW, pillY, 12);
      ctx.stroke();

      ctx.fillStyle = '#263238';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, pillX + pillW/2 - textW/2, pillY + pillH/2);
    }

    // Bancada (barra superior donde descansan √≠tems)
    ctx.fillStyle='#b0bec5'; roundRect(20, 100, world.w-40, 10, 6, true);

    // √çtems (imagen personalizada si existe; si no, vector)
    for (var bi=0; bi<bench.items.length; bi++){
      var it = bench.items[bi];
      if (it.placed) continue;
      var cx = it.x + (it.dragging ? it.dx : 0);
      var cy = it.y + (it.dragging ? it.dy : 0);
      ctx.fillStyle='rgba(0,0,0,.06)'; ctx.beginPath(); ctx.arc(cx, cy+it.s*0.56, it.s*0.36, 0, Math.PI*2); ctx.fill();
      drawItemWithImageOrVector(it.key, cx, cy, it.s);
    }

    // HUD dentro del canvas (tiempo)
    ctx.fillStyle='rgba(0,0,0,.25)'; roundRect(12, 12, 120, 30, 8, true);
    ctx.fillStyle='#fff'; ctx.font='bold 14px system-ui';
    var remain = Math.max(0, Math.ceil((world.duration - world.time)/1000));
    ctx.fillText('‚è± '+remain+'s', 20, 31);
  }

  function loop(ts){
    if (!world.running) return;
    var last = loop._last || ts;
    var dt = Math.min(32, ts - last); loop._last = ts;
    update(dt);
    updateHUD();
    draw();
    requestAnimationFrame(loop);
  }

  /* ===================== Utilidades dibujo ===================== */
  function roundRect(x,y,w,h,r, fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if (fill) ctx.fill(); else ctx.stroke();
  }
  function roundRectPath(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
  }

  /* ===================== Drag & drop ===================== */
  var dragging=null;
  function pickItemAt(px,py){
    for(var i=bench.items.length-1;i>=0;i--){
      var it = bench.items[i];
      if (it.placed) continue;
      var cx = it.x + (it.dragging ? it.dx : 0);
      var cy = it.y + (it.dragging ? it.dy : 0);
      if (px>cx-30 && px<cx+30 && py>cy-30 && py<cy+30){
        return it;
      }
    }
    return null;
  }
  function onPointerDown(ev){
    var rect = canvas.getBoundingClientRect();
    var x = (ev.touches? ev.touches[0].clientX: ev.clientX) - rect.left;
    var y = (ev.touches? ev.touches[0].clientY: ev.clientY) - rect.top;
    dragging = pickItemAt(x,y);
    if (dragging){ dragging.dragging=true; dragging.dx=0; dragging.dy=0; }
  }
  function onPointerMove(ev){
    if (!dragging) return;
    var rect = canvas.getBoundingClientRect();
    var x = (ev.touches? ev.touches[0].clientX: ev.clientX) - rect.left;
    var y = (ev.touches? ev.touches[0].clientY: ev.clientY) - rect.top;
    dragging.dx = x - dragging.x;
    dragging.dy = y - dragging.y;
    ev.preventDefault();
  }
  function onPointerUp(){
    if (!dragging) return;
    var dropX = dragging.x + dragging.dx, dropY = dragging.y + dragging.dy;
    var placed=false;
    for (var s=0; s<box.slots.length; s++){
      var sl = box.slots[s];
      if (sl.filled) continue;
      if (dropX>sl.x && dropX<sl.x+sl.w && dropY>sl.y && dropY<sl.y+sl.h){
        if (dragging.key === sl.key){
          sl.filled=true; dragging.placed=true; placed=true;
          var gained = Math.floor(50 * combo);
          score += gained; combo = Math.min(5, combo+1); comboTimer = 1600;
          if (box.slots.every(function(ss){ return ss.filled; })){
            score += 100 * combo; combo = Math.min(5, combo+1); comboTimer = 1600;
            level++;
            if (level >= RECIPES.length) { endGame(true); return; }
            currentRecipe = RECIPES[level];
            spawnBenchFor(currentRecipe);
            buildSlots(currentRecipe);
          }
        } else {
          // ‚ùå Penalizaci√≥n por herramienta incorrecta soltada en la caja
          score = Math.max(0, score - 25); // resta 25 puntos (evita negativos)
        }
        break;
      }
    }
    if (!placed){ dragging.dx=0; dragging.dy=0; }
    dragging.dragging=false; dragging=null;
  }
  canvas.addEventListener('mousedown', onPointerDown);
  canvas.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  canvas.addEventListener('touchstart', onPointerDown, {passive:false});
  canvas.addEventListener('touchmove', onPointerMove, {passive:false});
  window.addEventListener('touchend', onPointerUp);

  /* ===================== Pausa y reinicio ===================== */
  pauseBtn.addEventListener('click', function(){ if (!world.running) return; world.paused=!world.paused; pauseBtn.textContent = world.paused? '‚ñ∂Ô∏è Reanudar':'‚è∏Ô∏è Pausa'; });
  restartBtn.addEventListener('click', function(){ world.running=false; overlay.style.display='flex'; });

  /* ===================== Comod√≠n ===================== */
  powerBtn.addEventListener('click', function(){
    if (!world.running || world.paused || powerBtn.disabled) return;
    var sl = null;
    for (var i=0;i<box.slots.length;i++){ if (!box.slots[i].filled){ sl=box.slots[i]; break; } }
    if (!sl) return;
    powerBtn.disabled=true;
    sl.filled=true;
    var it = null;
    for (var j=0;j<bench.items.length;j++){ if (!bench.items[j].placed && bench.items[j].key===sl.key){ it = bench.items[j]; break; } }
    if (it) it.placed=true;
    score += Math.floor(50 * combo);
    combo = Math.min(5, combo+1); comboTimer = 1600;
    if (box.slots.every(function(ss){ return ss.filled; })){
      score += 100 * combo; combo = Math.min(5, combo+1); comboTimer = 1600;
      level++;
      if (level >= RECIPES.length) { endGame(true); return; }
      currentRecipe = RECIPES[level];
      spawnBenchFor(currentRecipe);
      buildSlots(currentRecipe);
    }
  });

  /* ===================== Inicio ===================== */
  overlay.style.display='flex';
  startBtn.addEventListener('click', startGame);

})();
</script>
</body>
</html>
