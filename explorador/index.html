
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Caza de hojas — Carta del explorador</title>
  <style>
    :root{ --ui:#0f172a; }
    html,body{height:100%;margin:0;background:#cfe8ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{display:flex;flex-direction:column;align-items:center}
    header{width:min(520px,95vw);display:flex;justify-content:space-between;align-items:center;margin:12px 0;color:var(--ui)}
    header .stat{display:flex;gap:12px;align-items:center;font-weight:600}
    canvas{background:#cfe8ff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.15);touch-action:none}
    .btn{appearance:none;border:none;background:#fff;color:#0f172a;border-radius:12px;padding:8px 12px;box-shadow:0 2px 10px rgba(0,0,0,.1);font-weight:600}
    .btn:active{transform:translateY(1px)}
    #controls{display:flex;gap:12px;margin:10px 0 18px}
    #controls .pad{width:84px;height:44px;border-radius:12px;background:#fff;border:none;box-shadow:0 2px 10px rgba(0,0,0,.1);font-weight:700}
    #power{background:linear-gradient(180deg,#ffe082,#ffd54f)}
    #power[disabled]{filter:grayscale(.8);opacity:.7}
    #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
    #overlay .card{width:min(560px,92vw);background:#fff;color:#0f172a;padding:18px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:center}
    footer{color:#3c4a4a;font-size:.9rem;margin:8px 0 20px}
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="stat">
      <span id="score">Puntos: 0</span>
      <span id="combo">Combo ×1</span>
    </div>
    <div class="stat">
      <button class="btn" id="pause">⏸️ Pausa</button>
    </div>
  </header>

  <canvas id="game" width="380" height="680" aria-label="Caza de hojas"></canvas>

  <div id="controls">
    <button class="pad" id="left">⬅️</button>
    <button class="btn" id="power" title="Ráfaga (limpia avispas) — 1 uso">⚡ Ráfaga</button>
    <button class="pad" id="right">➡️</button>
  </div>

  <footer>
    Récord: <span id="best">0</span> · Carta: <strong>explorador</strong>
  </footer>
</div>

<div id="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2>Caza de hojas</h2>
    <p>Arrastra para moverte y atrapa tus ítems favoritos. Evita las <strong>avispas</strong>. Tienes 3 corazones y una <strong>Ráfaga</strong> que limpia avispas.</p>
    <button class="btn" id="start">▶️ Empezar</button>
  </div>
</div>

<script>
(function(){
  /* ===== Canvas ===== */
  var DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var baseW = canvas.width, baseH = canvas.height;
  canvas.width = baseW * DPR; canvas.height = baseH * DPR;
  canvas.style.width = baseW + 'px'; canvas.style.height = baseH + 'px';
  ctx.scale(DPR, DPR);

  /* ===== UI ===== */
  var scoreEl = document.getElementById('score');
  var comboEl = document.getElementById('combo');
  var pauseBtn = document.getElementById('pause');
  var bestEl = document.getElementById('best');
  var overlay = document.getElementById('overlay');
  var startBtn = document.getElementById('start');
  var leftBtn = document.getElementById('left');
  var rightBtn = document.getElementById('right');
  var powerBtn = document.getElementById('power');

  var RECORD_KEY = 'bestScore_explorador';
  var best = +localStorage.getItem(RECORD_KEY) || 0;
  bestEl.textContent = best;

  /* ===== Mundo & jugador ===== */
  var world = { w: baseW, h: baseH, groundY: baseH - 64, running:false, paused:false, time:0, duration:75*1000 };
  var player = { x: Math.round(baseW/2), y: world.groundY-100, w: 56, h: 96, speed: 0.40, targetX: Math.round(baseW/2), sprite: new Image(), facing: 1 };
  player.sprite.src = 'assets/Explorador.png';

  /* ===== Estado ===== */
  var items = []; // objetos que caen
  var spawn = { next: 0, rateMs: 800, accel: 0.995, minRate: 360 };
  var score = 0, combo = 1, comboTimer = 0, lives = 3;

  /* ===== Tus iconos PNG (ajusta rutas exactas) ===== */
  var ICON_IMG_SRC = [
    'assets/hoja.png',
    'assets/mueble.png',
    'assets/fruta.png',
    'assets/pokeball.png'
  ];
  var GOOD_ICONS = ICON_IMG_SRC.map(function(src){ var im=new Image(); im.src=src; return im; });

  var WASP_IMG_SRC = 'assets/avispa.png'; // opcional
  var WASP_IMG = null; if (WASP_IMG_SRC){ WASP_IMG = new Image(); WASP_IMG.src = WASP_IMG_SRC; }

  /* ===== HUD ===== */
  function updateHUD(){ scoreEl.textContent = 'Puntos: ' + score; comboEl.textContent = 'Combo ×' + combo; }

  /* ===== Inicio / fin ===== */
  function startGame(){
    score=0; combo=1; comboTimer=0; lives=3;
    items.length=0;
    world.time=0; spawn.next=0; spawn.rateMs=800;
    overlay.style.display='none';
    powerBtn.disabled=false;
    world.running=true; world.paused=false;
    requestAnimationFrame(loop);
  }

  function endGame(){
    world.running=false;
    var prev = +localStorage.getItem(RECORD_KEY) || 0;
    if (score > prev) localStorage.setItem(RECORD_KEY, score);
    bestEl.textContent = localStorage.getItem(RECORD_KEY);
    document.querySelector('#overlay .card h2').textContent = '¡Fin de la partida!';
    document.querySelector('#overlay .card p').innerHTML =
      'Puntuación: <strong>'+score+'</strong>. Récord: <strong>'+bestEl.textContent+'</strong>.<br/>'+
      'Usa la <strong>Ráfaga</strong> si se complica.';
    overlay.style.display='flex';
  }

  /* ===== Aparición (con límite de avispas) ===== */
  var MAX_WASPS = 6;
  var WASP_BASE_PROB = 0.10;
  var WASP_MAX_PROB  = 0.40;
  function currentWaspProb(){
    var t = Math.min(1, world.time / world.duration);
    return WASP_BASE_PROB + (WASP_MAX_PROB - WASP_BASE_PROB) * t;
  }
  function countWasps(){ var c=0; for (var i=0;i<items.length;i++){ if (items[i].type==='wasp') c++; } return c; }

  function spawnItem(forceType){
    var type;
    var probWasp = currentWaspProb();
    var canSpawnWasp = countWasps() < MAX_WASPS;
    type = forceType ? forceType : ((Math.random() < probWasp && canSpawnWasp) ? 'wasp' : 'good');

    var size = (type==='wasp' ? 28 : 32);
    var iconIndex = -1;
    if (type==='good' && GOOD_ICONS.length>0) iconIndex = Math.floor(Math.random()*GOOD_ICONS.length);

    items.push({
      type: type,
      imgIndex: iconIndex,
      x: Math.random() * (world.w - size) + size/2,
      y: -size,
      vy: 80 + Math.random()*40,
      rot: Math.random()*Math.PI,
      size: size
    });
  }

  /* ===== Update ===== */
  function update(dt){
    world.time += dt;
    if (world.time >= world.duration || lives<=0){ endGame(); return; }

    spawn.next -= dt;
    if (spawn.next <= 0){
      spawnItem();
      spawn.rateMs = Math.max(spawn.minRate, spawn.rateMs * spawn.accel);
      spawn.next = spawn.rateMs;
    }

    /* === Movimiento SIN vibración ===
       - Dead-zone real: si |dx| < 1 px, NO movemos ni cambiamos facing.
       - Posiciones enteras (Math.round). */
    var dx = player.targetX - player.x;
    if (Math.abs(dx) >= 1){
      var dir = dx > 0 ? 1 : -1;
      player.facing = dir;
      player.x = Math.round(player.x + dir * player.speed * dt);
      if (player.x < player.w/2) player.x = player.w/2;
      if (player.x > world.w - player.w/2) player.x = world.w - player.w/2;
    }
    // Si está dentro del dead-zone, NO tocamos player.x ni facing

    // Caída / colisiones
    for (var i=items.length-1;i>=0;i--){
      var it = items[i];
      var fallBoost = 1 + (world.time/world.duration)*0.55;
      it.y += (it.vy * dt / 1000) * fallBoost;
      it.rot += 0.003 * dt; // rotación más lenta

      // Colisión con jugador
      if (rectsOverlap(player.x-player.w/2, player.y, player.w, player.h, it.x-it.size/2, it.y-it.size/2, it.size, it.size)){
        if (it.type==='wasp'){
          lives--; combo=1; comboTimer=0; items.splice(i,1);
          flash('#ffebee');
        } else {
          var base = 20;
          if (comboTimer>0) combo = Math.min(5, combo+1);
          comboTimer = 1400;
          score += Math.floor(base * combo);
          items.splice(i,1);
          flash('#e8f5e9');
        }
        updateHUD();
        continue;
      }

      // Fuera de pantalla
      if (it.y - it.size/2 > world.h){ items.splice(i,1); }
    }

    // Combo timer
    if (comboTimer > 0){ comboTimer -= dt; if (comboTimer <= 0){ comboTimer=0; combo=1; } }
  }

  /* ===== Draw ===== */
  function draw(){
    ctx.clearRect(0,0,world.w, world.h);
    drawBackground();

    // Ítems
    for (var k=0;k<items.length;k++){
      var it = items[k];
      ctx.save();
      ctx.translate(it.x, it.y);
      ctx.rotate(it.rot);
      if (it.type==='wasp'){ drawWaspIcon(it.size); } else { drawGoodIcon(it.size, it.imgIndex); }
      ctx.restore();
    }

    // Jugador (dibujado en enteros; sin vibración)
    var sx = Math.round(player.x - player.w/2), sy = Math.round(player.y);
    ctx.save();
    if (player.facing < 0){ ctx.translate(player.x, sy); ctx.scale(-1,1); ctx.translate(-player.x, -sy); }
    ctx.drawImage(player.sprite, sx, sy, player.w, player.h);
    ctx.restore();

    // HUD
    ctx.fillStyle = 'rgba(0,0,0,.25)';
    roundedRect(12, 12, 110, 28, 8);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 14px system-ui';
    var remain = Math.max(0, Math.ceil((world.duration - world.time)/1000));
    ctx.fillText('⏱ '+remain+'s', 20, 31);
  }

  function loop(ts){
    if (!world.running) return;
    if (world.paused){ requestAnimationFrame(loop); return; }
    var last = loop._last || ts;
    var dt = Math.min(32, ts - last); loop._last = ts;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  /* ===== Fondo ===== */
  function drawBackground(){
    // Cielo (gradiente)
    var skyGrad = ctx.createLinearGradient(0,0,0,world.h*0.70);
    skyGrad.addColorStop(0, '#cfe8ff');
    skyGrad.addColorStop(1, '#eaf5ff');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0,0,world.w, world.h*0.70);

    // Nubes
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    drawCloud(60, 80, 28);
    drawCloud(world.w-140, 60, 36);
    drawCloud(world.w/2, 100, 32);
    ctx.restore();

    // Suelo con varias bandas de verde + manchas
    var groundY = world.h*0.70;
    ctx.fillStyle = '#9bd59b'; ctx.fillRect(0, groundY, world.w, world.h-groundY);
    ctx.fillStyle = '#87cc89'; ctx.fillRect(0, groundY+18, world.w, world.h-groundY-18);
    ctx.fillStyle = '#79c37c'; ctx.fillRect(0, groundY+36, world.w, world.h-groundY-36);
    ctx.save();
    ctx.fillStyle = 'rgba(46,125,50,0.20)';
    for (var i=0;i<6;i++){
      var gx = 30 + i*(world.w/6);
      ctx.beginPath();
      ctx.ellipse(gx, world.h-40, 80, 22, 0, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }
  function drawCloud(cx, cy, r){
    ctx.beginPath();
    ctx.arc(cx-r, cy, r*0.9, 0, Math.PI*2);
    ctx.arc(cx, cy-r*0.3, r, 0, Math.PI*2);
    ctx.arc(cx+r, cy, r*0.8, 0, Math.PI*2);
    ctx.fill();
  }

  /* ===== Iconos ===== */
  function drawGoodIcon(s, imgIndex){
    var img = (imgIndex>=0 && imgIndex<GOOD_ICONS.length) ? GOOD_ICONS[imgIndex] : null;
    if (img && img.complete && img.naturalWidth && img.naturalWidth>0){
      ctx.drawImage(img, -s/2, -s/2, s, s);
    } else {
      // respaldo simple
      ctx.fillStyle = '#2e7d32';
      roundedRect(-s/2, -s/2, s, s, s/4);
      ctx.fillStyle = '#1b5e20';
      ctx.fillRect(-s/2+6, -s/2+6, s-12, s-12);
    }
  }
  function drawWaspIcon(s){
    if (WASP_IMG && WASP_IMG.complete && WASP_IMG.naturalWidth && WASP_IMG.naturalWidth>0){
      ctx.drawImage(WASP_IMG, -s/2, -s/2, s, s);
      return;
    }
    roundedRect(-s/2, -s/2, s, s, s/3);
    ctx.fillStyle = '#fdd835'; roundedRect(-s/2, -s/2, s, s, s/3);
    ctx.fillStyle = '#000';
    ctx.fillRect(-s/2, -s/2+4, s, 5);
    ctx.fillRect(-s/2, -s/2+14, s, 5);
    ctx.fillRect(-s/2, -s/2+24, s, 5);
    ctx.beginPath();
    ctx.moveTo(s/2, 0); ctx.lineTo(s/2+8, 0); ctx.lineTo(s/2, 6); ctx.closePath(); ctx.fill();
  }

  /* ===== Utils ===== */
  function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh){
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }
  function roundedRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.fill();
  }

  /* ===== Input ===== */
  function setTargetFromEvent(ev){
    var rect = canvas.getBoundingClientRect();
    var x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
    player.targetX = Math.round(x);
  }
  canvas.addEventListener('touchstart', function(e){ setTargetFromEvent(e); e.preventDefault(); }, {passive:false});
  canvas.addEventListener('touchmove',  function(e){ setTargetFromEvent(e); e.preventDefault(); }, {passive:false});
  canvas.addEventListener('mousedown', setTargetFromEvent);
  canvas.addEventListener('mousemove', setTargetFromEvent);

  var leftHeld=false, rightHeld=false;
  leftBtn.addEventListener('touchstart', function(e){ leftHeld=true; e.preventDefault(); }, {passive:false});
  rightBtn.addEventListener('touchstart', function(e){ rightHeld=true; e.preventDefault(); }, {passive:false});
  leftBtn.addEventListener('touchend', function(){ leftHeld=false; });
  rightBtn.addEventListener('touchend', function(){ rightHeld=false; });
  leftBtn.addEventListener('mousedown', function(){ leftHeld=true; });
  rightBtn.addEventListener('mousedown', function(){ rightHeld=true; });
  window.addEventListener('mouseup', function(){ leftHeld=false; rightHeld=false; });

  (function btnMoveLoop(){
    if (world.running && !world.paused){
      if (leftHeld){
        var nx = Math.round(player.x - 12);
        player.targetX = Math.max(player.w/2, nx);
      } else if (rightHeld){
        var nx2 = Math.round(player.x + 12);
        player.targetX = Math.min(world.w - player.w/2, nx2);
      }
      // si no se pulsa nada, NO tocamos targetX ⇒ el jugador queda completamente parado
    }
    requestAnimationFrame(btnMoveLoop);
  })();

  // Pausa
  pauseBtn.addEventListener('click', function(){
    world.paused = !world.paused;
    pauseBtn.textContent = world.paused ? '▶️ Reanudar' : '⏸️ Pausa';
  });

  // Ráfaga (limpia avispas) — 1 uso
  powerBtn.addEventListener('click', function(){
    if (!world.running || world.paused || powerBtn.disabled) return;
    var removed = 0;
    for (var i=items.length-1;i>=0;i--){
      if (items[i].type==='wasp'){ items.splice(i,1); removed++; }
    }
    if (removed>0){ score += removed*5; updateHUD(); flash('#fff8e1'); }
    powerBtn.disabled = true;
  });

  // Inicio
  overlay.style.display='flex';
  startBtn.addEventListener('click', startGame);

  /* ===== Flash visual ===== */
  var flashTimer = 0, flashColor = '#fff';
  function flash(color){ flashTimer = 120; flashColor = color; }
  var lastDraw = draw;
  draw = function(){
    lastDraw();
    if (flashTimer > 0){
      flashTimer -= 16;
      ctx.save();
      ctx.fillStyle = flashColor; ctx.globalAlpha = Math.max(0, flashTimer/120)*0.25;
      ctx.fillRect(0,0,world.w, world.h);
      ctx.restore();
    }
  };

})();
</script>
</body>
</html>
